{% extends 'base.html.twig' %}

{% block title %}SgrEvento index{% endblock %}

{% block stylesheets %}
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/css/tempusdominus-bootstrap-4.min.css" />
{% endblock %}


{% block body %}
    <h1>Calendarios</h1>

    <div id="filtros">
        <div class="mt-3 mb-3">

            {# include('sgr_calendarios/_form.html.twig', {'button_label': 'Mostrar eventos'}) #}
            {{ include('sgr_form/_formFiltersSrgEvento.html.twig', {'button_label': 'Filtrar eventos'}) }}
        </div>
    </div>
    
    
    {% set diasSemana = {1: 'Lunes', 2:'Martes', 3: 'Miércoles',4: 'Jueves',5: 'Viernes',6: 'Sábado' } %}
    {% if aCalendarios is defined %}
    <table class="table table-striped table-bordered">  
    {# for cod, dia in diasSemana #}
    {% for calendario in aCalendarios %}
    <tr>
        <th>{# dia #}{{ calendario.sgrEspacio.nombre }}</th>
        <td>
    <table class="table table-striped table-bordered ">
        <caption class="text-center">Cuadrante de ocupación: Desde<b> {{ data['begin']|format_datetime('full','none',locale='es')|capitalize }}</b> hasta<b> {{ data['end']|format_datetime('full','none',locale='es')|capitalize }}</b> ({{ calendario.sgrEspacio.nombre }}) </caption>
        <thead class="thead-dark">
            <tr>
                <th scope="col" style="max-width: 100px"><div class="col">Hora</div></th>
                
                {% set start_h = constant('\\App\\Entity\\SgrEvento::H_INICIO_MIN') | date('U') %}
                {% set end_h = constant('\\App\\Entity\\SgrEvento::H_FIN_MAX') | date('U') %}   
                {% set step = 60*60 %} {# 3 horas en segundos #}
                {% set setpMinutes = 60 %} {# 3 horas en minutos #}
                
                 
                {% for hour in range(start_h, end_h, step) %}
                
                        <th scope="col" >
                            <div class="col text-center" ><span >{{ hour|date('H:i') }}</span> - <span>{{ (hour + step)|date('H:i') }}</span></div>
                        </th>
                {% endfor %}
                
                
            </tr>
        </thead>
        <tbody>
                    
            {# for calendario in aCalendarios #}
            {% for cod, dia in diasSemana %}
                <tr style="">
                    <th scope="row" >
                        <div class="col">{{ dia }}{# calendario.sgrEspacio.nombre #}</div>
                    </th>
                {% for hour in range(start_h, end_h, step) %}   
                    <td style="padding: 0px;">
                        <div class="e" style="position: relative;min-height: 60px;height: 100%;">

                            
                            <div style="width:100%;position: absolute;min-height: 35px;height: 100%;">
                                {% for i in range(0,1) %}
                                    <a href="#newSgrEventoModal" data-remote="{{path('sgr_calendarios_new')}}" data-toggle="modal" data-target="#newSgrEventoModal" data-whatever="@mdo" class="divModal" data-espacio="{{calendario.sgrEspacio.id}}" data-codigodia="{{ cod -1 }}" data-hinicio="{{ hour|date('H:i') }}" data-hfin="{{ (hour+step)|date('H:i') }}">
                                    <div style="float: left;width: 50%;height: 100%;border-left: 1px dotted gray;"></div>
                                </a>    
                                {% endfor %}

                            </div>
                        
                            {% if not calendario.periods is empty %}
                                {% set bandera = 0 %}

                                {% set repe = false %}
                                {% for period in calendario.periods %}
                                
                                    
                                {% for codDiaEvento in period.evento.dias %}
                                        

                                    
                                    
                                {% if codDiaEvento == cod %}    

                                    
                                    {% if period.datePeriod.start|date('H:i') >= hour|date('H:i') and period.datePeriod.start|date('H:i') < (hour+step)|date('H:i') %}


                                    {% set h_inicio =  date( period.datePeriod.start|date('H:i') )  %}
                                    {% set h_fin =  date( period.datePeriod.end|date('H:i') )  %}
                                    {% set duration = (h_fin.diff(h_inicio).format('%H')*60 + h_fin.diff(h_inicio).format('%i')) %}
                                    {% set w = 100*duration / 60 %}
                                    
                                    {% set h_cuadrante =  date( hour|date('H:i') )  %}
                                    {% set diffInMinutes = (h_cuadrante.diff(h_inicio).format('%H')*60 + h_cuadrante.diff(h_inicio).format('%i')) %}
                                    {% set offset = 100*diffInMinutes / 60 %}
                                        {% if (bandera == period.datePeriod.start|date('H:i') ~ codDiaEvento) %}
                                            {% set offset = offset  + 30 %}
                                            {% set w = w - 30 %}
                                        {% endif %}     
                                        <div style="z-index: 2;
                                            width: {{ w }}%;
                                            position:absolute;
                                            top:0px;
                                            left:{{ offset }}%;
                                            background-color: #bbb;
                                            height: 58px;
                                            border-left: 1px solid white">
                                            
                                            <a  href="javascript:;" data-animation="true" tabindex="0" data-trigger="focus" data-html="true"  data-toggle="popover" title="Información de la Reserva" data-content="<div class='text-center'>
                                            <p><b>{{ period.evento.titulo }}</b></p>
                                            <p>{{ period.evento.actividad }}</p>
                                            <p>{{ period.evento.fInicio|date('d-m-Y') }} - {{ period.evento.fFin|date('d-m-Y') }}</p>
                                            <p>{{ period.evento.hInicio|date('H:i')}} - {{ period.evento.hFin|date('H:i') }}</p>
                                            <p>{{ period.evento.getDiasStringFormat|join(', ',' y ') }}</p>
                                            <p>{{period.evento.espacio}}</p></div>"
                                            >   
                                                <div class="badge badge-info text-wrap p-2" style="width: 100%;height: 58px;">
                                                    <div class="align-middle text-truncate">
                                                    {{ period.evento.titulo }}
                                                    </div>
                                                    <div class="align-bottom">
                                                            <span class="text-sm-left">{{ period.evento.hInicio|date('H:i') }}</span>
                                                            <span class="text-sm-right">{{ period.evento.hFin|date('H:i') }}</span>
                                                    </div>  
                                                </div>
                                            </a>
                                            {% set f_inicio =  period.datePeriod.start %}
                                            {% set f_fin =  period.datePeriod.end %}
                                            {% set diff = f_inicio.diff(f_fin).format('%d') %}

                                            {# numdaysView --> pasada desde controlador = número de días entre f_inicio y f_fin elegido por el usuario  #}
                                            {% if diff == 0%}
                                                {% set diff = 1 %}
                                            {% endif %}
                                            {% if numDaysView != 0 %}
                                                {% set anchor = (diff * 100) / numDaysView %}
                                            {% else %}
                                            {# la diferencia entre f_inicio y f_fin es cero, osea, f_inicio = f_fin #}                          {% set anchor = 100 %}
                                            {% endif %}

                                            {#dump(anchor)#}
                                            {#
                                            <div style="height: 10px;background-color: red;width: {{ anchor  }}%;float:left;"></div>
                                            <div style="height: 10px;background-color: green;width: Calc(100% - {{anchor}}%);float:left"></div>     
                                            #}
                                        </div>

                                        {% set bandera = period.datePeriod.start|date('H:i') ~ codDiaEvento %}
                                    {% endif %}
                                {% endif %}
                                {% endfor %}
                                {% endfor %}
                            {% endif %}
                        
                        </div>

                    </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
        </td>
    {%endfor%}
    </table>
    {%else%}
        <div class="alert alert-primary p-4" role="alert">
            Seleccione criterios de busqueda... 
        </div>
    {%endif%}

    {# include('sgr_modal/_formNewEvento.html.twig', {form: formNewSgrEvento}) #}
    <div class="modal fade" id="newSgrEventoModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newSgrEventoModalLabel">Calendarios: Nuevo Evento</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                ... remote content from "data-remote" loads here ...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Salvar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block morescripts %}
    
    <script type="text/javascript">        
        $(function () {
            $('[data-toggle="popover"]').popover({
                trigger: 'focus',
                animation: true,
                delay: { "show": 300, "hide": 100 },
            });
        });
    </script>
    
    <script type="text/javascript" src="/build/formFiltersInput.js"></script>
    <script type="text/javascript" src="/build/datetimepickerInit.js"></script>
    <script type="text/javascript" src="/build/hinclude.js"></script>
    <!-- 
        <script type="text/javascript" src="/reservasfgh/public/build/formFiltersInput.js"></script>
        <script type="text/javascript" src="/reservasfgh/public/build/datetimepickerInit.js"></script>
        <script type="text/javascript" src="/reservasfgh/public/build/hinclude.js"></script>
    -->

    <script type="text/javascript">

        $(function() {

            $('#newSgrEventoModal').on('show.bs.modal', function (e){
                //e.preventDefault();
                //alert('asdad');
                var button = $(e.relatedTarget);
                var modal = $(this);
                //console.log(e.relatedTarget);

                // load content from HTML string
                //modal.find('.modal-body').html("Nice modal body baby...");
                var data = {};
                // or, load content from value of data-remote url
                modal.find('.modal-body').load(button.data("remote"),button,function(){
                    
                    $('#sgr_filters_sgr_eventos_f_inicio') ? $f_inicio = $('#sgr_filters_sgr_eventos_f_inicio').val() : null;
                    $f_inicio ? $('#sgr_evento_f_inicio').val($f_inicio) : null;

                    $('#sgr_filters_sgr_eventos_f_fin') ? $('#sgr_evento_f_fin').val($('#sgr_filters_sgr_eventos_f_fin').val()) : null;

                    button.data('espacio') ? $('#sgr_evento_espacio').val(button.data('espacio')) : null; 

                    $('.sgr_evento_dias').each(function(){ button.prop('checked', false); });
                    button.data('codigodia') !== false ? $('#sgr_evento_dias_'+button.data('codigodia')).prop('checked', true) : null;

                    button.data('hinicio') ? $('#sgr_evento_h_inicio').val(button.data('hinicio')) : null;
                
                    button.data('hfin') ? $('#sgr_evento_h_fin').val(button.data('hfin')) : null;

                    $('#sgr_evento_submit').click(function(e){
                
                        e.preventDefault();
                        
                        //Add input hide
                        //input = jQuery('<input name="filters[termino]" type="hidden" value="'+$('#sgr_filters_sgr_eventos_termino').val()+'">');
                        /*input = jQuery('<input name="filters" type="hidden" value="'+
                            JSON.stringify($('form[name="sgr_filters_sgr_eventos"]'))
                            +'">');
                        */
                        //console.log(input);
                        //console.log($('form[name="sgr_filters_sgr_eventos"]'));
                        //jQuery('form[name="sgr_evento"]').append(input);
                        //console.log($('form[name="sgr_evento"]'));
                        //console.log($('form[name="sgr_evento"]').attr('action'));
                        $('form[name="sgr_evento"]').attr('action','/admin/sgr/calendario/ajax/new/evento');
                        //$('form[name="sgr_evento"]').submit();
                          
                        //$('form[name="sgr_filters_sgr_eventos"]').submit();
                        //alert('asdadasd');
                var data = $('form[name="sgr_evento"]').serialize();
                $.ajax({
                    url : '/admin/sgr/calendario/ajax/new/evento',
                    type: 'POST',//$form.attr('method'),
                    data : data,
                    success: function(respuesta) {
                        //console.log(respuesta);
                        if (respuesta == true){
                            modal.hide();
                            $('form[name="sgr_filters_sgr_eventos"]').submit();

                        }
                        else{
                            $('#errors').hide().html(respuesta.content).fadeIn('slow','linear');
                            
                            console.log(respuesta);
                        }

                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        alert(xhr.responseText + ' (codeError: ' + xhr.status  +')');
                    }
                });
                        
                    });
                });
            });

            
            /*
            $('form[name="sgr_evento"]').submit(function(e){

                e.preventDefault();
                alert('asdadasd');
                var data = $(this).serialize();
                $.ajax({
                    url : '/admin/sgr/calendario/ajax/new/evento',
                    type: 'POST',//$form.attr('method'),
                    data : data,
                    success: function(respuesta) {
                        console.log(respuesta);
                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        alert(xhr.responseText + ' (codeError: ' + xhr.status  +')');
                    }
                });
                

            });
            */


            /*$('#theModal').on('show.bs.modal', function (e) {

                var button = $(e.relatedTarget);
                var modal = $(this);

                // load content from HTML string
                //modal.find('.modal-body').html("Nice modal body baby...");

                // or, load content from value of data-remote url
                modal.find('.modal-body').load(button.data("remote"));

            });*/


        });
    </script>
{% endblock %}