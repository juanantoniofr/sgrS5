{% extends 'base.html.twig' %}

{% block title %}SgrEvento index{% endblock %}

{% block stylesheets %}
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/css/tempusdominus-bootstrap-4.min.css" />
{% endblock %}


{% block body %}
    <h1>Calendarios</h1>

    <div id="filtros">
        <div class="mt-3 mb-3">
            {{ include('sgr_form/_formFiltersSrgEvento.html.twig', {'button_label': 'Filtrar eventos'}) }}
        </div>
    </div>
 
    {% set diasSemana = {1: 'Lunes', 2:'Martes', 3: 'Miércoles',4: 'Jueves',5: 'Viernes',6: 'Sábado' } %}
    {% if aCalendarios is defined %}
    {# dump(aCalendarios) #}
    

    <table class="table table-striped table-bordered">  
        
        <caption class="text-center">

            Cuadrante de ocupación: Desde<b> {{ data['begin']|format_datetime('full','none',locale='es')|capitalize }}</b> hasta<b> {{ data['end']|format_datetime('full','none',locale='es')|capitalize }}</b>
        </caption>
        
        <thead class="thead-dark">
            <tr>
                <th scope="col"><div class="col">#</div></th>
                
                {% set start_h = constant('\\App\\Entity\\SgrEvento::H_INICIO_MIN') | date('U') %}
                {% set end_h = constant('\\App\\Entity\\SgrEvento::H_FIN_MAX') | date('U') %}   
                {% set step = 60*60 %} {# 3 horas en segundos #}
                {% set setpMinutes = 60 %} {# 3 horas en minutos #}
                
                 
                {% for hour in range(start_h, end_h, step) %}
                
                        <th scope="col" style="width: 100px">
                            <div class="col text-center" ><span >{{ hour|date('H:i') }}</span> - <span>{{ (hour + step)|date('H:i') }}</span></div>
                        </th>
                {% endfor %}
                
                
            </tr>
        </thead>
        <tbody>
            {% for calendario in aCalendarios %}
                <tr>
                    <th>{{ calendario.sgrEspacio.nombre }}</th>
                
                    {% for hour in range(start_h, end_h, step) %}
                        <td style="padding: 0px;">
                        <div class="e" style="position: relative;height: 100px;">

                            
                            <div style="width:100%;position: absolute;min-height: 35px;height: 100%;">
                                {% for i in range(0,1) %}
                                    <a href="#newSgrEventoModal" data-remote="{{path('sgr_calendarios_new')}}" data-toggle="modal" data-target="#newSgrEventoModal" data-whatever="@mdo" class="divModal" data-espacio="{{calendario.sgrEspacio.id}}" data-codigodia="{# cod -1 #}" data-hinicio="{{ hour|date('H:i') }}" data-hfin="{{ (hour+step)|date('H:i') }}">
                                    <div style="float: left;width: 50%;height: 100%;border-left: 1px dotted gray;"></div>
                                </a>    
                                {% endfor %}

                            </div>

                            {% if not calendario.periods is empty %}
                                
                                {% for period in calendario.periods %}

                                {% if period.datePeriod.start|date('H:i') >= hour|date('H:i') and period.datePeriod.start|date('H:i') < (hour+step)|date('H:i') %}
                                
                                {% set h_inicio =  date( period.datePeriod.start|date('H:i') )  %}
                                {% set h_fin =  date( period.datePeriod.end|date('H:i') )  %}
                                {% set duration = (h_fin.diff(h_inicio).format('%H')*60 + h_fin.diff(h_inicio).format('%i')) %}
                                

                                {% set h_cuadrante =  date( hour|date('H:i') )  %}

                                {% set diffInMinutes = (h_cuadrante.diff(h_inicio).format('%H')*60 + h_cuadrante.diff(h_inicio).format('%i')) %}
                                
                                {% set offset = 100*diffInMinutes / 60 %}

                                <div class="evento bg-info" data-duration="{{duration}}" style="z-index: 2;
                                            
                                            left:{{ offset }}%;
                                            position:absolute;
                                            top:0px;
                                            height: 100%;
                                            border: 1px solid white">
                                            
                                            <a  href="javascript:;" data-animation="true" tabindex="0" data-trigger="focus" data-html="true"  data-toggle="popover" title="Información de la Reserva" data-content="<div class='text-center'>
                                            <p><b>{{ period.evento.titulo }}</b></p>
                                            <p>{{ period.evento.actividad }}</p>
                                            <p>{{ period.evento.fInicio|date('d-m-Y') }} - {{ period.evento.fFin|date('d-m-Y') }}</p>
                                            <p>{{ period.evento.hInicio|date('H:i')}} - {{ period.evento.hFin|date('H:i') }}</p>
                                            <p>{{ period.evento.getDiasStringFormat|join(', ',' y ') }}</p>
                                            <p>{{period.evento.espacio}}</p></div>"
                                            >   
                                                <div class="badge badge-info text-left" style="width: 100%;height: 100%;">
                                                    <div class="align-middle text-wrap text-truncate">
                                                    {{ period.evento.titulo }} (
                                                    <span class="text-sm-left">{{ period.evento.hInicio|date('H:i') }}</span>-<span class="text-sm-right">{{ period.evento.hFin|date('H:i') }}</span>)
                                                    </div>
                                                        
                                                </div>
                                            </a>
                                </div>
                                

                                {% endif %}
                                {% endfor %}

                            {% endif %} 
                        </div>   
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>


    {%else%}
        <div class="alert alert-primary p-4" role="alert">
            Seleccione criterios de busqueda... 
        </div>
    {%endif%}

    <div class="modal fade" id="newSgrEventoModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newSgrEventoModalLabel">Calendarios: Nuevo Evento</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                ... remote content from "data-remote" loads here ...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Salvar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block morescripts %}
    
    <script type="text/javascript">        
        $(function () {
            $('.evento').each(function(){
                var $wtd = $(this).closest("td").width() + 2; //2 pixels del border del td
                var $duration = $(this).data('duration');
                /*
                    60m => wtd
                    duration => x 
                */
                $(this).width( ($wtd * $duration) / 60 );
                $htd = $(this).closest("td").height();
            });
        });
    </script>

    <script type="text/javascript">        
        $(function () {
            $('[data-toggle="popover"]').popover({
                trigger: 'focus',
                animation: true,
                delay: { "show": 300, "hide": 100 },
            });
        });
    </script>
    
    <script type="text/javascript" src="/build/formFiltersInput.js"></script>

    <script type="text/javascript" src="/build/datetimepickerInit.js"></script>
    <script type="text/javascript" src="/build/datetimepicker-calendarViewDay.js"></script>

    
    <!-- 
        <script type="text/javascript" src="/reservasfgh/public/build/formFiltersInput.js"></script>
        <script type="text/javascript" src="/reservasfgh/public/build/datetimepickerInit.js"></script>
        <script type="text/javascript" src="/reservasfgh/public/build/datetimepicker-calendarViewDay.js"></script>

        
    -->

    <script type="text/javascript">

        $(function() {

            $('#showMoreFilters').click( function(e){
                e.preventDefault();//     toggle: false
            });

            //id modal 
            $('#newSgrEventoModal').on('show.bs.modal', function (e){
                
                var button = $(e.relatedTarget);
                var modal = $(this);
                var data = {};
                // load content from value of data-remote url
                modal.find('.modal-body').load(button.data("remote"),button,function(){
                    
                    if ($('#sgr_filters_sgr_eventos_f_inicio')){
                        $('#sgr_evento_f_inicio').val($('#sgr_filters_sgr_eventos_f_inicio').val());
                        $('#sgr_evento_f_fin').val($('#sgr_filters_sgr_eventos_f_inicio').val());
                    } 
                    
                    button.data('espacio') ? $('#sgr_evento_espacio').val(button.data('espacio')) : null; 

                    $('.sgr_evento_dias').each(function(){ button.prop('checked', false); });
                    button.data('codigodia') !== false ? $('#sgr_evento_dias_'+button.data('codigodia')).prop('checked', true) : null;

                    button.data('hinicio') ? $('#sgr_evento_h_inicio').val(button.data('hinicio')) : null;
                
                    button.data('hfin') ? $('#sgr_evento_h_fin').val(button.data('hfin')) : null;

                    $('#sgr_evento_submit').click(function(e){
                
                        e.preventDefault();
                        
                        $('form[name="sgr_evento"]').attr('action','/admin/sgr/calendario/ajax/new/evento');
                        
                        var data = $('form[name="sgr_evento"]').serialize();
                        $.ajax({
                            url : '/admin/sgr/calendario/ajax/new/evento',
                            type: 'POST',//$form.attr('method'),
                            data : data,
                            success: function(respuesta) {
                                console.log(respuesta);
                                console.log($('#errors'));

                                //$('#errors').html(respuesta.content).fadeIn('slow','linear');
                                if (respuesta)
                                {
                                    modal.hide();
                                    $('form[name="sgr_filters_sgr_eventos"]').submit();
                                }
                                else
                                {
                                    $('#errors').hide().html(respuesta.content).fadeIn('slow','linear');
                                    
                                   
                                }

                            },
                            error: function(xhr, ajaxOptions, thrownError){
                                alert(xhr.responseText + ' (codeError: ' + xhr.status  +')');
                            }
                        });//fin Ajax
                                
                    });//fin Submit
                });//show.bs.modal
            });//fin id modal

        });
    </script>
{% endblock %}